<script src="http://cdnjs.cloudflare.com/ajax/libs/d3/3.4.0/d3.min.js"></script>

<style>
* {
    padding: 0;
    margin: 0;
}

body {
    font: 14px/1.5 "Lucida Grande", "Lucida Sans Unicode", "Helvetica", "Arial", "Verdana", "sans-serif"

}

.table {
    stroke: black;
    stroke-width:0.5px;
    fill: transparent;
}

#more {
    position:absolute;
    top:1em;
    right:1em;
    padding:.5em .8em .3em;
    border:1px solid #0f0f0f;
    color: #0f0f0f;
    text-transform:uppercase;
    font-size:.75em;
    font-weight:bold;
    font-family: helvetica;
    border-radius:3px;
    transition:.1s ease-in all;
    text-decoration:none;
}
#more:hover {
    background:#0f0f0f;
    color:white;
}

.info {
    position:absolute;
    left:1em;
    top:1em;
    max-width:450px;
    padding:1em;
    background:white;
    border-radius:.5em;
    border:1px solid #f3f3f3;
}

.info img {
    float:left;
    margin:0 1em 0 0;
    width:128px;
    height:128px;
}
.info .bd {
    overflow:hidden;
}

.question {
    margin:.5em 0;
    clear:both;
    font-size:1.05em;
    color:#9a9a9a;
}
</style>

<a href="#" id="more">Load More</a>

<div class="info"></div>
<div id="discover"> </div>

<script>
var DataFeed = function(data) {
    this.data = data;
    this.offset = 0;
    this.count = 20;
};

DataFeed.prototype = {
    next: function() {
        var data = this.data.slice(this.offset, this.offset + this.count);
        this.offset += this.count;
        return data;
    }
};

var feed,
    dropbox = 'https://dl.dropboxusercontent.com/u/9219059/luk3thomas.com/labs/round-table/images/';
    center = {
        x: (innerWidth - 75) / 2,
        y: innerHeight / 2
    },
    nodes = [{
        fixed: true,
        x: center.x,
        y: center.y
    }];

var force = d3.layout.force()
    .gravity(0)
    .nodes(nodes)
    .start();

var svg = d3.select('#discover').append('svg:svg')
    .attr('width', innerWidth)
    .attr('height', innerHeight)

var draw = function() {

    nodes.forEach(function(d){
        d.width =  d.width || 0.01;
        d.height = d.height ||0.01;
        d.size = d.size || {
            width: 64,
            height: 64
        };
    });

    svg.selectAll('.person')
        .data(nodes.slice(1))
        .enter()
        .append('image')
            .attr({
                class: 'person',
                width: 0,
                height: 0,
                'xlink:href': function(d) { return [dropbox, d.image].join('') },
            })
            .call(force.drag)

    svg.selectAll('.person')
        .on('mouseenter', function(d){
            d3.select('.info')
                .html([
                    '<img src="', dropbox, d.image, '" />',
                    '<div class="bd">',
                        '<h3 class="name">', d.name, '</h3>',
                        '<blockquote class="question">', d.question, '</blockquote>',
                        '<p class="answer">', d.answer, '</p>',
                    '</div>'
                ].join(''));
        });

    svg.selectAll('.table')
        .data(nodes.slice(0, 1))
        .enter()
        .append('circle')
            .attr({
                class: 'table',
                r: 100,
                cx: center.x ,
                cy: center.y 
            })
            .call(force.drag)

    force
        .nodes(nodes)
        .charge(function(d){ return d.fixed ? -1000 : -40; })
        .on('tick', function(e){

            nodes.forEach(function(d, i){
                d.x += (center.x - d.x) * e.alpha * 0.04;
                d.y += (center.y - d.y) * e.alpha * 0.04;

                // We could use d3.transition() for the width / height
                // for some reason, the transition is smmother inside the
                // tick callback
                if(!d.fixed) {
                    d.width = Math.min(d.width + d.size.width * 0.01, d.size.width);
                    d.height = Math.min(d.height + d.size.height * 0.01, d.size.height);
                }
            });

            d3.selectAll('.person')
                .attr('x', function(d){ return d.x })
                .attr('y', function(d){ return d.y })
                .attr('width', function(d){ return d.width })
                .attr('height', function(d){ return d.height })

            d3.selectAll('.table')
                .attr('cx', function(d){ return d.x + 35 })
                .attr('cy', function(d){ return d.y + 35 })

        })
        .start();
}

d3.json("/labs/data/2014-06-07-round-table/people.json", function(data){
    feed = new DataFeed(data);
    nodes = nodes.concat(feed.next());
    draw();
});

document.getElementById('more').addEventListener('click', function(){
    nodes = nodes.concat(feed.next());
    draw();
}, false);

</script>
